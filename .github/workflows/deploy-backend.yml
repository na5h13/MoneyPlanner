name: Deploy Backend to Railway

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'railway.json'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: na5h13/keel-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ghcr.io/${{ env.IMAGE_NAME }}:latest
            ghcr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          platforms: linux/amd64

      - name: Make package public
        run: |
          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d '{"visibility":"public"}' \
            "https://api.github.com/user/packages/container/keel-backend" | jq .message

      - name: Update Railway service image and redeploy
        run: |
          TOKEN="${{ secrets.RAILWAY_TOKEN }}"
          SERVICE_ID="8f07e133-cbc7-4ea6-916d-4ef032cfc048"
          ENV_ID="7d1f25c8-7ba5-41fe-a583-61d35d02de44"
          IMAGE="ghcr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # Update source to Docker image
          curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { serviceInstanceUpdate(serviceId: \\\"$SERVICE_ID\\\", environmentId: \\\"$ENV_ID\\\", input: { source: { image: \\\"$IMAGE\\\" } }) }\"}" | jq .

          # Trigger redeploy
          curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { serviceInstanceRedeploy(serviceId: \\\"$SERVICE_ID\\\", environmentId: \\\"$ENV_ID\\\") }\"}" | jq .
