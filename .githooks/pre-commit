#!/bin/bash
# Pre-commit hook â€” blocks commits containing secrets or credentials
# Adapted from Ruflo v3.5 for Keel v3
# Install: git config core.hooksPath .githooks

echo "Running pre-commit secret scan..."

BLOCKED=0

# Patterns that should never appear in committed code
# Note: patterns must not start with -- (grep interprets as flag)
# Note: use assignment context (=|:) for env var names to avoid matching comments
SECRET_PATTERNS=(
    'sk-[a-zA-Z0-9]{20,}'                    # OpenAI API key
    'ghp_[a-zA-Z0-9]{36,}'                   # GitHub personal access token
    'gho_[a-zA-Z0-9]{36,}'                   # GitHub OAuth token
    'npm_[a-zA-Z0-9]{36,}'                   # npm token
    'AKIA[A-Z0-9]{16}'                        # AWS access key
    'BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY'   # Private keys
    'FIREBASE_SERVICE_ACCOUNT_KEY[= :]'        # Firebase service account value
    'PLAID_SECRET[= :]'                        # Plaid secret value
    'ENCRYPTION_KEY[= :]'                      # Encryption key value
)

# Only scan staged files (not the whole repo)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

for pattern in "${SECRET_PATTERNS[@]}"; do
    # Search staged content (not filenames)
    MATCHES=$(git diff --cached -U0 2>/dev/null | grep -E "^\+" | grep -v "^+++" | grep -iE "$pattern" | head -3)
    if [ -n "$MATCHES" ]; then
        echo ""
        echo "  COMMIT BLOCKED - Secret pattern detected: $pattern"
        echo "$MATCHES" | head -3 | sed 's/^/    /'
        BLOCKED=1
    fi
done

# Also check for .env files being committed
ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env($|\.)' | grep -v '\.example$' | grep -v '\.sample$')
if [ -n "$ENV_FILES" ]; then
    echo ""
    echo "  COMMIT BLOCKED - .env file staged:"
    echo "$ENV_FILES" | sed 's/^/    /'
    echo "  Use .env.example for templates. Never commit real .env files."
    BLOCKED=1
fi

# Check for google-services.json
GS_FILES=$(echo "$STAGED_FILES" | grep -E 'google-services\.json$')
if [ -n "$GS_FILES" ]; then
    echo ""
    echo "  COMMIT BLOCKED - google-services.json staged:"
    echo "$GS_FILES" | sed 's/^/    /'
    BLOCKED=1
fi

if [ $BLOCKED -ne 0 ]; then
    echo ""
    echo "  Remove secrets before committing."
    echo "  To bypass (NOT recommended): git commit --no-verify"
    exit 1
fi

echo "  Pre-commit scan passed"
exit 0
